{% extends "base.html" %}
{% load static %}

{% block title %}Add NFC Tag - {{ asset.name }} - {{ SITE_NAME }}{% endblock %}

{% block extra_head %}
<style>[x-cloak] { display: none !important; }</style>
{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto space-y-6"
     data-site-url="{{ site_url }}"
     data-asset-barcode="{{ asset.barcode }}"
     x-data="{
        nfcSupported: false,
        scanning: false,
        scannedTagId: '',
        showWritePrompt: false,
        writeSuccess: false,
        writeError: '',
        init() {
            this.nfcSupported = ('NDEFReader' in window);
        },
        async startScan() {
            this.scanning = true;
            this.writeError = '';
            this.showWritePrompt = false;
            this.writeSuccess = false;
            try {
                const reader = new NDEFReader();
                const ac = new AbortController();
                this._abortController = ac;
                await reader.scan({ signal: ac.signal });
                reader.addEventListener('reading', ({ serialNumber }) => {
                    this.scannedTagId = serialNumber || '';
                    if (this.scannedTagId) {
                        document.getElementById('tag_id').value = this.scannedTagId;
                        this.scanning = false;
                        this.showWritePrompt = true;
                        if (ac) ac.abort();
                    }
                });
                reader.addEventListener('readingerror', () => {
                    this.writeError = 'Error reading NFC tag. Please try again.';
                    this.scanning = false;
                });
            } catch (e) {
                this.writeError = 'NFC scan failed: ' + e.message;
                this.scanning = false;
            }
        },
        cancelScan() {
            if (this._abortController) this._abortController.abort();
            this.scanning = false;
        },
        async confirmWrite() {
            const siteUrl = this.$root.dataset.siteUrl;
            const barcode = this.$root.dataset.assetBarcode;
            const tagId = document.getElementById('tag_id').value;
            const url = siteUrl + '/a/' + tagId + '/';
            try {
                const writer = new NDEFReader();
                await writer.write({
                    records: [
                        { recordType: 'url', data: url },
                        { recordType: 'text', data: barcode }
                    ]
                });
                this.writeSuccess = true;
                this.showWritePrompt = false;
                // Auto-submit the form after successful write
                this.$nextTick(() => {
                    document.getElementById('nfc-form').submit();
                });
            } catch (e) {
                this.writeError = 'Failed to write tag: ' + e.message;
                this.showWritePrompt = false;
            }
        },
        skipWrite() {
            this.showWritePrompt = false;
        }
     }">
    <div>
        <h1 class="font-display text-2xl font-bold">Add NFC Tag</h1>
        <p class="text-stage-500 dark:text-cream/50 mt-1">{{ asset.name }} &middot; <span class="font-mono">{{ asset.barcode }}</span></p>
    </div>

    <form method="post" id="nfc-form" class="space-y-5">
        {% csrf_token %}

        <div class="bg-white/50 dark:bg-stage-800/50 backdrop-blur-sm rounded-xl border border-stage-200 dark:border-white/5 p-6 space-y-5">
            {# NFC Scan Button (Web NFC only) #}
            <div x-show="nfcSupported" x-cloak>
                <button type="button"
                        x-show="!scanning && !showWritePrompt"
                        @click="startScan()"
                        class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg text-sm font-medium transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    Scan NFC Tag
                </button>

                {# Scanning state #}
                <div x-show="scanning" class="text-center py-4 space-y-3">
                    <div class="inline-block w-8 h-8 border-2 border-blue-500/30 border-t-blue-500 rounded-full animate-spin"></div>
                    <p class="text-blue-400 text-sm">Hold your device near the NFC tag...</p>
                    <button type="button" @click="cancelScan()" class="text-stage-500 dark:text-cream/50 text-xs hover:text-stage-700 dark:hover:text-cream/70 transition-colors">Cancel</button>
                </div>

                {# Write confirmation prompt #}
                <div x-show="showWritePrompt" x-cloak class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4 space-y-3">
                    <p class="text-sm text-stage-900 dark:text-cream">
                        Tag scanned: <span class="font-mono" x-text="scannedTagId"></span>
                    </p>
                    <p class="text-sm text-stage-600 dark:text-cream/70">
                        Program this tag with the asset URL? This will overwrite the tag's current data.
                    </p>
                    <div class="flex gap-2">
                        <button type="button" @click="confirmWrite()"
                                class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg text-sm font-medium transition-colors">
                            Program Tag
                        </button>
                        <button type="button" @click="skipWrite()"
                                class="flex-1 bg-stage-100 dark:bg-stage-700 hover:bg-stage-200 dark:hover:bg-stage-600 text-stage-600 dark:text-cream/70 py-2 rounded-lg text-sm font-medium transition-colors">
                            Skip
                        </button>
                    </div>
                </div>

                {# Write success #}
                <div x-show="writeSuccess" x-cloak class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-4">
                    <p class="text-sm text-emerald-400">Tag programmed successfully. Saving...</p>
                </div>

                {# Error display #}
                <div x-show="writeError" x-cloak class="bg-red-500/10 border border-red-500/20 rounded-lg p-3">
                    <p class="text-sm text-red-400" x-text="writeError"></p>
                </div>

                <div class="border-t border-stage-200 dark:border-white/10 pt-4 mt-2">
                    <p class="text-xs text-stage-500 dark:text-cream/40 mb-3">Or enter the tag ID manually:</p>
                </div>
            </div>

            <div>
                <label for="tag_id" class="block text-sm font-medium text-stage-600 dark:text-cream/70 mb-1.5">Tag ID *</label>
                <input type="text" name="tag_id" id="tag_id" required
                    class="form-input w-full rounded-lg px-4 py-2.5 text-stage-900 dark:text-cream"
                    placeholder="Scan or enter NFC tag ID">
            </div>

            <div>
                <label for="notes" class="block text-sm font-medium text-stage-600 dark:text-cream/70 mb-1.5">Notes (optional)</label>
                <textarea name="notes" id="notes" rows="3"
                    class="form-input w-full rounded-lg px-4 py-2.5 text-stage-900 dark:text-cream"
                    placeholder="Any notes about this NFC tag..."></textarea>
            </div>
        </div>

        <div class="flex gap-3">
            <button type="submit" class="flex-1 bg-brand-500 hover:bg-brand-400 text-stage-900 py-3 rounded-lg text-base font-semibold btn-press transition-all">
                Add NFC Tag
            </button>
            <a href="{% url 'assets:asset_detail' asset.pk %}" class="px-6 py-3 bg-stage-100 dark:bg-stage-700 hover:bg-stage-200 dark:hover:bg-stage-600 text-stage-600 dark:text-cream/70 rounded-lg text-base font-medium transition-colors text-center">
                Cancel
            </a>
        </div>
    </form>
</div>

<script src="{% static 'js/nfc.js' %}"></script>
{% endblock %}
