{% extends "base.html" %}

{% block title %}{% if category %}Edit {{ category.name }}{% else %}Create Category{% endif %} - {{ SITE_NAME }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<style>
    .material-symbols-outlined { font-family: 'Material Symbols Outlined'; font-size: 24px; line-height: 1; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto space-y-6">
    <div>
        <h1 class="font-display text-3xl font-bold">{% if category %}Edit Category{% else %}Create Category{% endif %}</h1>
        {% if category %}
        <p class="text-stage-500 dark:text-cream/50 mt-1">{{ category.name }}</p>
        {% endif %}
    </div>

    <form method="post" class="space-y-6">
        {% csrf_token %}

        {% if form.errors %}
        <div class="bg-red-500/10 border border-red-500/20 rounded-xl p-4">
            <p class="text-red-600 dark:text-red-300 text-sm font-medium mb-2">Please fix the following errors:</p>
            <ul class="text-red-600 dark:text-red-300/70 text-sm space-y-1">
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                    <li>{{ field|title }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="bg-white/50 dark:bg-stage-800/50 backdrop-blur-sm rounded-xl border border-stage-200 dark:border-white/5 p-6 space-y-5">
            <h2 class="text-lg font-medium text-stage-800 dark:text-cream/90 border-b border-stage-200 dark:border-white/5 pb-3">Category Details</h2>

            <div>
                <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-stage-600 dark:text-cream/70 mb-1.5">Name *</label>
                {{ form.name }}
            </div>

            <div>
                <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-stage-600 dark:text-cream/70 mb-1.5">Description</label>
                {{ form.description }}
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-stage-600 dark:text-cream/70 mb-1.5">Icon</label>
                    {{ form.icon }}
                    <!-- Icon picker UI -->
                    <div class="flex items-center gap-3 mb-3" id="icon-selected-row">
                        <div id="icon-preview" class="w-10 h-10 rounded-lg bg-stage-100 dark:bg-stage-700 flex items-center justify-center text-stage-500 dark:text-cream/50">
                            <span class="material-symbols-outlined" id="icon-preview-symbol">category</span>
                        </div>
                        <span id="icon-selected-name" class="text-sm text-stage-500 dark:text-cream/60 font-mono"></span>
                        <button type="button" id="icon-clear-btn" class="hidden text-stage-500 dark:text-cream/40 hover:text-stage-900 dark:hover:text-cream text-xs transition-colors">(clear)</button>
                    </div>
                    <button type="button" id="icon-picker-toggle" class="text-sm text-spotlight-400 hover:text-spotlight-600 dark:text-spotlight-300 transition-colors">Choose icon...</button>
                    <div id="icon-picker" class="hidden mt-2 bg-stage-100 dark:bg-stage-700 border border-stage-200 dark:border-white/10 rounded-lg p-3 space-y-2">
                        <input type="text" id="icon-search" class="form-input w-full rounded-lg px-3 py-1.5 text-stage-900 dark:text-cream text-sm" placeholder="Search icons..." autocomplete="off">
                        <div id="icon-grid" class="grid grid-cols-6 gap-1 max-h-48 overflow-y-auto"></div>
                    </div>
                </div>
                <div>
                    <div class="flex items-center gap-2 mb-1.5">
                        <label for="{{ form.department.id_for_label }}" class="block text-sm font-medium text-stage-600 dark:text-cream/70">Department *</label>
                        <button type="button" id="add-dept-btn" class="inline-flex items-center justify-center w-5 h-5 rounded bg-spotlight-500/20 text-spotlight-400 hover:bg-spotlight-500/30 hover:text-spotlight-600 dark:text-spotlight-300 text-xs font-bold transition-colors" title="Create new department">+</button>
                    </div>
                    {{ form.department }}
                </div>
            </div>
        </div>

        <div class="flex gap-3">
            <button type="submit" class="flex-1 bg-spotlight-500 hover:bg-spotlight-400 text-stage-900 py-3 rounded-lg text-base font-semibold btn-press transition-all">
                {% if category %}Update Category{% else %}Create Category{% endif %}
            </button>
            <a href="{% url 'assets:category_list' %}" class="px-6 py-3 bg-stage-100 dark:bg-stage-700 hover:bg-stage-200 dark:hover:bg-stage-600 text-stage-600 dark:text-cream/70 rounded-lg text-base font-medium transition-colors text-center">
                Cancel
            </a>
        </div>
    </form>
</div>

<!-- Inline department create modal -->
<div id="dept-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="dept-modal-backdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-white dark:bg-stage-800 border border-stage-200 dark:border-white/10 rounded-xl shadow-2xl w-full max-w-sm pointer-events-auto">
            <div class="flex items-center justify-between p-5 border-b border-stage-200 dark:border-white/5">
                <h3 class="text-lg font-medium text-stage-900 dark:text-cream">Create Department</h3>
                <button type="button" id="dept-modal-close" class="text-stage-500 dark:text-cream/40 hover:text-stage-900 dark:hover:text-cream transition-colors">&times;</button>
            </div>
            <div class="p-5">
                <label for="dept-name-input" class="block text-sm font-medium text-stage-600 dark:text-cream/70 mb-1.5">Name *</label>
                <input type="text" id="dept-name-input" class="form-input w-full rounded-lg px-4 py-2.5 text-stage-900 dark:text-cream" placeholder="Department name">
                <p id="dept-error" class="hidden mt-2 text-red-400 text-sm"></p>
            </div>
            <div class="flex justify-end gap-3 p-5 border-t border-stage-200 dark:border-white/5">
                <button type="button" id="dept-cancel-btn" class="px-4 py-2 bg-stage-100 dark:bg-stage-700 hover:bg-stage-200 dark:hover:bg-stage-600 text-stage-600 dark:text-cream/70 rounded-lg text-sm transition-colors">Cancel</button>
                <button type="button" id="dept-save-btn" class="px-4 py-2 bg-spotlight-500 hover:bg-spotlight-400 text-stage-900 rounded-lg text-sm font-medium transition-colors">Create</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    var csrfToken = '{{ csrf_token }}';

    // =====================
    // Icon picker
    // =====================
    var ICONS = [
        // General / common
        'category', 'label', 'inventory_2', 'package_2', 'box', 'archive',
        'shelves', 'warehouse', 'storefront', 'store', 'shopping_cart',
        // Furniture & spaces
        'chair', 'table_restaurant', 'bed', 'door_front', 'window', 'stairs',
        'deck', 'fence', 'garage', 'roofing', 'kitchen',
        // Tech & electronics
        'computer', 'laptop', 'phone_android', 'tablet', 'monitor', 'tv',
        'keyboard', 'mouse', 'print', 'scanner', 'router', 'dns',
        'memory', 'usb', 'cable', 'power', 'battery_charging_full',
        'headphones', 'speaker', 'mic', 'videocam', 'camera', 'photo_camera',
        // Tools & equipment
        'build', 'handyman', 'construction', 'hardware', 'plumbing',
        'electrical_services', 'bolt', 'settings', 'tune',
        'precision_manufacturing', 'factory',
        // Transport & vehicles
        'directions_car', 'local_shipping', 'airport_shuttle', 'two_wheeler',
        'pedal_bike', 'sailing', 'flight',
        // Arts & performance
        'theater_comedy', 'music_note', 'piano', 'brush', 'palette',
        'draw', 'auto_fix_high', 'movie', 'slideshow',
        // Clothing & costumes
        'checkroom', 'dry_cleaning',
        // Lighting
        'light', 'lightbulb', 'highlight', 'flashlight', 'flare',
        'wb_incandescent', 'wb_sunny',
        // Office & documents
        'description', 'folder', 'topic', 'article', 'receipt_long',
        'badge', 'work', 'business_center',
        // Safety & security
        'health_and_safety', 'security', 'shield', 'lock', 'key',
        'fire_extinguisher', 'emergency',
        // Science & medical
        'science', 'biotech', 'medical_services', 'medication',
        // Sports & outdoors
        'sports_soccer', 'fitness_center', 'hiking', 'camping', 'park',
        // Food & drink
        'restaurant', 'local_cafe', 'local_bar', 'bakery_dining',
        // People & groups
        'person', 'group', 'groups', 'school', 'psychology',
        // Misc
        'flag', 'star', 'favorite', 'bookmark', 'pin_drop',
        'event', 'schedule', 'attach_money', 'payments',
        'recycling', 'eco', 'compost', 'water_drop',
    ];

    var hiddenInput = document.getElementById('id_icon');
    var preview = document.getElementById('icon-preview-symbol');
    var selectedName = document.getElementById('icon-selected-name');
    var clearBtn = document.getElementById('icon-clear-btn');
    var pickerToggle = document.getElementById('icon-picker-toggle');
    var picker = document.getElementById('icon-picker');
    var iconGrid = document.getElementById('icon-grid');
    var iconSearch = document.getElementById('icon-search');

    // Init from existing value
    var currentIcon = hiddenInput.value || '';
    if (currentIcon) {
        preview.textContent = currentIcon;
        preview.classList.remove('text-stage-500', 'dark:text-cream/50');
        preview.classList.add('text-spotlight-400');
        selectedName.textContent = currentIcon;
        clearBtn.classList.remove('hidden');
        pickerToggle.textContent = 'Change icon...';
    }

    pickerToggle.addEventListener('click', function() {
        picker.classList.toggle('hidden');
        if (!picker.classList.contains('hidden')) {
            iconSearch.value = '';
            renderGrid(ICONS);
            iconSearch.focus();
        }
    });

    iconSearch.addEventListener('input', function() {
        var q = iconSearch.value.trim().toLowerCase();
        if (!q) { renderGrid(ICONS); return; }
        var filtered = ICONS.filter(function(name) {
            return name.replace(/_/g, ' ').indexOf(q) !== -1 || name.indexOf(q) !== -1;
        });
        renderGrid(filtered);
    });

    clearBtn.addEventListener('click', function() {
        hiddenInput.value = '';
        currentIcon = '';
        preview.textContent = 'category';
        preview.classList.add('text-stage-500', 'dark:text-cream/50');
        preview.classList.remove('text-spotlight-400');
        selectedName.textContent = '';
        clearBtn.classList.add('hidden');
        pickerToggle.textContent = 'Choose icon...';
    });

    function renderGrid(icons) {
        while (iconGrid.firstChild) iconGrid.removeChild(iconGrid.firstChild);
        icons.forEach(function(name) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'w-9 h-9 rounded-lg flex items-center justify-center hover:bg-stage-100 dark:hover:bg-white/10 transition-colors' +
                (name === currentIcon ? ' bg-spotlight-500/20 ring-1 ring-spotlight-500' : '');
            btn.title = name;
            var icon = document.createElement('span');
            icon.className = 'material-symbols-outlined text-stage-600 dark:text-cream/70 hover:text-stage-900 dark:hover:text-cream';
            icon.style.fontSize = '20px';
            icon.textContent = name;
            btn.appendChild(icon);
            btn.addEventListener('click', function() { selectIcon(name); });
            iconGrid.appendChild(btn);
        });
        if (icons.length === 0) {
            var empty = document.createElement('div');
            empty.className = 'col-span-6 text-center text-sm text-stage-500 dark:text-cream/40 py-2';
            empty.textContent = 'No matching icons';
            iconGrid.appendChild(empty);
        }
    }

    function selectIcon(name) {
        hiddenInput.value = name;
        currentIcon = name;
        preview.textContent = name;
        preview.classList.remove('text-stage-500', 'dark:text-cream/50');
        preview.classList.add('text-spotlight-400');
        selectedName.textContent = name;
        clearBtn.classList.remove('hidden');
        pickerToggle.textContent = 'Change icon...';
        picker.classList.add('hidden');
    }

    // =====================
    // Department modal
    // =====================
    var createUrl = '{% url "assets:department_create_inline" %}';
    var modal = document.getElementById('dept-modal');
    var nameInput = document.getElementById('dept-name-input');
    var errorEl = document.getElementById('dept-error');
    var deptSelect = document.getElementById('id_department');

    function openDeptModal() {
        nameInput.value = '';
        errorEl.classList.add('hidden');
        errorEl.textContent = '';
        modal.classList.remove('hidden');
        nameInput.focus();
    }

    function closeDeptModal() {
        modal.classList.add('hidden');
    }

    document.getElementById('add-dept-btn').addEventListener('click', openDeptModal);
    document.getElementById('dept-modal-close').addEventListener('click', closeDeptModal);
    document.getElementById('dept-cancel-btn').addEventListener('click', closeDeptModal);
    document.getElementById('dept-modal-backdrop').addEventListener('click', closeDeptModal);

    modal.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); saveDept(); }
        if (e.key === 'Escape') closeDeptModal();
    });

    document.getElementById('dept-save-btn').addEventListener('click', saveDept);

    function saveDept() {
        var name = nameInput.value.trim();
        if (!name) {
            errorEl.textContent = 'Name is required';
            errorEl.classList.remove('hidden');
            return;
        }
        fetch(createUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({name: name}),
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                errorEl.textContent = data.error;
                errorEl.classList.remove('hidden');
                return;
            }
            var opt = document.createElement('option');
            opt.value = data.id;
            opt.textContent = data.name;
            opt.selected = true;
            deptSelect.appendChild(opt);
            closeDeptModal();
        })
        .catch(function() {
            errorEl.textContent = 'Request failed. Please try again.';
            errorEl.classList.remove('hidden');
        });
    }
})();
</script>
{% endblock %}
