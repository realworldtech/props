name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip

      - name: Install dependencies
        run: pip install black isort flake8

      - name: Check black formatting
        run: black --check --line-length 79 --target-version py312 src/

      - name: Check isort ordering
        run: isort --check --profile black --line-length 79 src/

      - name: Run flake8
        run: flake8 src/

  test:
    name: Test (Docker)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Build and run tests
        run: docker compose -f docker-compose.ci.yml up --build --exit-code-from web

      - name: Clean up
        if: always()
        run: docker compose -f docker-compose.ci.yml down -v

  requirements-check:
    name: Requirements in sync
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify every package in requirements.in appears in requirements.txt
        run: |
          missing=0
          while IFS= read -r line; do
            # Skip comments, blank lines, and options
            line=$(echo "$line" | sed 's/#.*//' | xargs)
            [ -z "$line" ] && continue
            [[ "$line" == -* ]] && continue
            # Extract package name (before any version specifier)
            pkg=$(echo "$line" | sed 's/\[.*\]//' | sed 's/[><=!].*//' | xargs | tr '[:upper:]' '[:lower:]')
            [ -z "$pkg" ] && continue
            if ! grep -qi "^${pkg}[>=<! \[]" requirements.txt && ! grep -qi "# via.*-r requirements.in" requirements.txt; then
              # Check if it appears as a dependency at all
              if ! grep -qi "^${pkg}" requirements.txt; then
                echo "MISSING: $pkg is in requirements.in but not in requirements.txt"
                missing=1
              fi
            fi
          done < requirements.in
          if [ "$missing" -eq 1 ]; then
            echo "requirements.txt is out of sync with requirements.in. Run 'pip-compile requirements.in' and commit the result."
            exit 1
          fi
          echo "All packages from requirements.in found in requirements.txt"
