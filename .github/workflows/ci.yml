name: CI

on:
  pull_request:
    branches: [develop, main]

concurrency:
  group: ci-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip

      - name: Install dependencies
        run: pip install black isort flake8

      - name: Check black formatting
        run: black --check --line-length 79 --target-version py312 src/

      - name: Check isort ordering
        run: isort --check --profile black --line-length 79 src/

      - name: Run flake8
        run: flake8 src/

  requirements-check:
    name: Requirements in sync
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify every package in requirements.in appears in requirements.txt
        run: |
          missing=0
          while IFS= read -r line; do
            line=$(echo "$line" | sed 's/#.*//' | xargs)
            [ -z "$line" ] && continue
            [[ "$line" == -* ]] && continue
            pkg=$(echo "$line" | sed 's/\[.*\]//' | sed 's/[><=!].*//' | xargs | tr '[:upper:]' '[:lower:]')
            [ -z "$pkg" ] && continue
            if ! grep -qi "^${pkg}[>=<! \[]" requirements.txt && ! grep -qi "# via.*-r requirements.in" requirements.txt; then
              if ! grep -qi "^${pkg}" requirements.txt; then
                echo "MISSING: $pkg is in requirements.in but not in requirements.txt"
                missing=1
              fi
            fi
          done < requirements.in
          if [ "$missing" -eq 1 ]; then
            echo "requirements.txt is out of sync with requirements.in. Run 'pip-compile requirements.in' and commit the result."
            exit 1
          fi
          echo "All packages from requirements.in found in requirements.txt"

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, requirements-check]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: props:ci-test
          build-args: |
            APP_VERSION=ci-${{ github.sha }}
            GIT_COMMIT=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save image as artifact
        run: docker save props:ci-test | gzip > /tmp/props-ci.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/props-ci.tar.gz
          retention-days: 1

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load image
        run: gunzip -c /tmp/props-ci.tar.gz | docker load

      - name: Run tests
        run: CI_IMAGE=props:ci-test docker compose -f docker-compose.ci.yml up --exit-code-from web

      - name: Clean up
        if: always()
        run: docker compose -f docker-compose.ci.yml down -v
